name: Deploy Next.js App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Setting up SSH Connection
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          # Navigate to the app directory
          cd htdoc/${{ secrets.DOMAIN }}

          # Create .env file from GitHub secrets
          echo "NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}" > .env
          echo "NEXT_PUBLIC_SANITY_DATASET=${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}" > .env
          echo "RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}" >> .env
          # Add other environment variables as needed

          # Pull the latest changes from the main branch
          git pull origin main

          # Install dependencies
          yarn

          # Build the app
          yarn build

          # Restart the app using PM2
          pm2 restart ${{ secrets.APP_NAME }}
